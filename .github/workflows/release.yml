name: Release

on:
  workflow_dispatch:
    inputs:
      bump-type:
        description: 'Bump type'
        required: true
        default: 'patch'
        type: choice
        options:
        - major
        - minor
        - patch

jobs:
  bump-version:
    runs-on: ubuntu-latest
    outputs:
      current-version: ${{ steps.bump.outputs.current-version }}
    steps:
      - name: Checkout the code
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
        
      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Bump version
        id: bump
        uses: callowayproject/bump-my-version@master
        env:
          BUMPVERSION_TAG: "true"
        with:
          args: ${{ inputs.bump-type }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check
        if: steps.bump.outputs.bumped == 'true'
        run: |
          echo "Version was bumped from ${{ steps.bump.outputs.previous-version }} to ${{ steps.bump.outputs.current-version }}!"


  release:
    needs: bump-version
    runs-on: ubuntu-latest
    steps:
      - name: Draft release with Release Drafter
        id: release
        uses: release-drafter/release-drafter@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag: "v${{ needs.bump-version.outputs.current-version }}"
          name: Release "v${{ needs.bump-version.outputs.current-version }}"
          publish: true
      
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup environment
        uses: ./.github/actions/setup
      
      - name: Build distributions
        run: uv build

      - name: Upload wheel asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.release.outputs.upload_url }}
          asset_path: ./dist/testrepo2-${{ needs.bump-version.outputs.current-version }}-py3-none-any.whl
          asset_name: testrepo2-${{ needs.bump-version.outputs.current-version }}-py3-none-any.whl
          asset_content_type: application/octet-stream

      - name: Upload tarball asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.release.outputs.upload_url }}
          asset_path: ./dist/testrepo2-${{ needs.bump-version.outputs.current-version }}.tar.gz
          asset_name: testrepo2-${{ needs.bump-version.outputs.current-version }}.tar.gz
          asset_content_type: application/gzip

      - name: Login to github reg
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          push: true
          tags: user/testrepo:${{ needs.bump-version.outputs.current-version }}
